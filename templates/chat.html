<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="header-content">
                <div class="bot-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="header-info">
                    <h1>RAG Chatbot</h1>
                    <span class="status">Connected to Knowledge Base</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="clear-chat" onclick="clearChat()">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>

        <!-- Chat Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Welcome message -->
            <div class="message bot-message">
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <p>Hello! I'm your RAG-powered AI assistant. I can answer questions based on the knowledge base. How can I help you today?</p>
                    </div>
                    <div class="message-time">
                        <span id="welcomeTime"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Typing Indicator -->
        <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type your message here..." 
                    rows="1"
                    onkeydown="handleKeyPress(event)"
                ></textarea>
                <button class="send-button" onclick="sendMessage()" id="sendButton">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        let messageHistory = [];
        
        // Load chat history from session storage on page load
        function loadChatHistory() {
            const savedHistory = sessionStorage.getItem('chatHistory');
            if (savedHistory) {
                messageHistory = JSON.parse(savedHistory);
                // Restore chat messages on screen
                const messagesContainer = document.getElementById('chatMessages');
                messagesContainer.innerHTML = ''; // Clear welcome message
                
                messageHistory.forEach(msg => {
                    addMessageToScreen(msg.text, msg.sender, msg.time);
                });
            }
        }
        
        // Save chat history to session storage
        function saveChatHistory() {
            // Keep only last 20 Q&A pairs (40 messages)
            if (messageHistory.length > 40) {
                messageHistory = messageHistory.slice(-40);
            }
            sessionStorage.setItem('chatHistory', JSON.stringify(messageHistory));
        }
        
        // Initialize chat
        window.onload = function() {
            loadChatHistory(); // Load saved chat from session storage
            if (messageHistory.length === 0) {
                // Show welcome message only if no chat history
                document.getElementById('welcomeTime').textContent = getCurrentTime();
            }
            adjustTextareaHeight();
        };

        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Auto-resize textarea
        document.getElementById('messageInput').addEventListener('input', adjustTextareaHeight);

        function adjustTextareaHeight() {
            const textarea = document.getElementById('messageInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // Generate unique session ID for this browser tab
        let sessionId = sessionStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('sessionId', sessionId);
        }
        
        // Send message function
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message === '') return;

            // Disable send button to prevent multiple requests
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Add user message to chat
            addMessage(message, 'user');
            
            // Clear input
            input.value = '';
            adjustTextareaHeight();
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Create form data to send to Flask backend
                const formData = new FormData();
                formData.append('msg', message);
                formData.append('session_id', sessionId);  // Send unique session ID

                // Send request to Flask backend
                const response = await fetch('/get', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const botResponse = await response.text();
                    hideTypingIndicator();
                    addMessage(botResponse, 'bot');
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage('Sorry, I encountered an error while processing your message. Please try again.', 'bot');
            } finally {
                // Re-enable send button
                sendButton.disabled = false;
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Add message to chat
        function addMessage(text, sender) {
            const currentTime = getCurrentTime();
            
            // Add to screen
            addMessageToScreen(text, sender, currentTime);
            
            // Store in history and session storage
            messageHistory.push({
                text: text,
                sender: sender,
                time: currentTime
            });
            
            // Save to session storage
            saveChatHistory();
        }
        
        // Helper function to add message to screen
        function addMessageToScreen(text, sender, currentTime) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}-message`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <p>${escapeHtml(text)}</p>
                        </div>
                        <div class="message-time">
                            <span>${currentTime}</span>
                        </div>
                    </div>
                    <div class="message-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <p>${escapeHtml(text)}</p>
                        </div>
                        <div class="message-time">
                            <span>${currentTime}</span>
                        </div>
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'flex';
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }


        // Clear chat function
        function clearChat() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = `
                <div class="message bot-message">
                    <div class="message-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <p>Hello! I'm your RAG-powered AI assistant. I can answer questions based on the knowledge base. How can I help you today?</p>
                        </div>
                        <div class="message-time">
                            <span>${getCurrentTime()}</span>
                        </div>
                    </div>
                </div>
            `;
            messageHistory = [];
            // Clear session storage
            sessionStorage.removeItem('chatHistory');
        }

        // Get current time
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
</body>
</html>